#include <gb/gb.h>
#ifndef TEXT_RENDER_DEFINITION

unsigned char alphabet[] = {
    // Blank
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    // a
    0xFF,0xFF,0xE7,0xE7,0xC3,0xC3,0xDB,0xDB,
    0x89,0x89,0xA1,0xA1,0xBD,0xBD,0xFF,0xFF,
    // b
    0xFF,0xFF,0x8F,0x8F,0xB7,0xB7,0xB7,0xB7,
    0x87,0x87,0xBB,0xBB,0x83,0x83,0xFF,0xFF,
    // c
    0xFF,0xFF,0xE3,0xE3,0xDF,0xDF,0xBF,0xBF,
    0xBF,0xBF,0xBD,0xBD,0xC3,0xC3,0xFF,0xFF,
    // d
    0xFF,0xFF,0x83,0x83,0xBD,0xBD,0xBD,0xBD,
    0xBD,0xBD,0xB9,0xB9,0x83,0x83,0xFF,0xFF,
    // e
    0xFF,0xFF,0xE3,0xE3,0xDF,0xDF,0xBF,0xBF,
    0x83,0x83,0xBF,0xBF,0x83,0x83,0xFF,0xFF,
    // f
    0xFF,0xFF,0xC3,0xC3,0xBF,0xBF,0xBF,0xBF,
    0x87,0x87,0xBF,0xBF,0xBF,0xBF,0xFF,0xFF,
    // g
    0xFF,0xFF,0xC3,0xC3,0xBF,0xBF,0xBF,0xBF,
    0xB7,0xB7,0xBB,0xBB,0xC3,0xC3,0xFF,0xFF,
    // h
    0xFB,0xFB,0xFB,0xFB,0xBB,0xBB,0xBB,0xBB,
    0x83,0x83,0xBB,0xBB,0xBB,0xBB,0xFF,0xFF,
    // i 
    0xFF,0xFF,0xC7,0xC7,0xEF,0xEF,0xEF,0xEF,
    0xEF,0xEF,0xEF,0xEF,0xC7,0xC7,0xFF,0xFF,
    // j
    0xFF,0xFF,0xC3,0xC3,0xFB,0xFB,0xFB,0xFB,
    0xFB,0xFB,0xBB,0xBB,0xC7,0xC7,0xFF,0xFF,
    // k
    0xFF,0xFF,0xB7,0xB7,0xB7,0xB7,0xAF,0xAF,
    0x8F,0x8F,0xB7,0xB7,0xBB,0xBB,0xFF,0xFF,
    // l
    0xFF,0xFF,0xBF,0xBF,0xBF,0xBF,0xBF,0xBF,
    0xBF,0xBF,0xBF,0xBF,0x83,0x83,0xFF,0xFF,
    // m
    0xFF,0xFF,0xB9,0xB9,0x91,0x91,0x85,0x85,
    0xA5,0xA5,0xB5,0xB5,0xBD,0xBD,0xFF,0xFF,
    // n
    0xFF,0xFF,0xBD,0xBD,0x9D,0x9D,0x8D,0x8D,
    0xA5,0xA5,0xB1,0xB1,0xB9,0xB9,0xFF,0xFF,
    // o
    0xFF,0xFF,0xFF,0xFF,0xC7,0xC7,0xD7,0xD7,
    0xD7,0xD7,0xC7,0xC7,0xFF,0xFF,0xFF,0xFF,
    // p
    0xFF,0xFF,0xC3,0xC3,0xDB,0xDB,0xDB,0xDB,
    0xC7,0xC7,0xDF,0xDF,0xDF,0xDF,0xFF,0xFF,
    // q
    0xFF,0xFF,0xC7,0xC7,0xBB,0xBB,0xBB,0xBB,
    0xAB,0xAB,0xB7,0xB7,0xCB,0xCB,0xFF,0xFF,
    // r
    0xFF,0xFF,0x87,0x87,0xBB,0xBB,0xBB,0xBB,
    0x87,0x87,0xB7,0xB7,0xBB,0xBB,0xFF,0xFF,
    // s
    0xFF,0xFF,0xC7,0xC7,0xBB,0xBB,0xBF,0xBF,
    0xC3,0xC3,0xFD,0xFD,0xBD,0xBD,0x83,0x83,
    // t
    0xFF,0xFF,0x81,0x81,0xEF,0xEF,0xEF,0xEF,
    0xEF,0xEF,0xEF,0xEF,0xEF,0xEF,0xFF,0xFF,
    // u 
    0xFF,0xFF,0xBD,0xBD,0xBD,0xBD,0xBD,0xBD,
    0xBD,0xBD,0xBB,0xBB,0xC7,0xC7,0xFF,0xFF,
    // v
    0xFF,0xFF,0xBD,0xBD,0xBD,0xBD,0xBD,0xBD,
    0xBD,0xBD,0xDB,0xDB,0xE7,0xE7,0xFF,0xFF,
    // w
    0xFF,0xFF,0xBD,0xBD,0xBD,0xBD,0xBD,0xBD,
    0xA5,0xA5,0xD9,0xD9,0xDD,0xDD,0xFF,0xFF,
    // x
    0xBF,0xBF,0xBF,0xBF,0x9D,0x9D,0xC9,0xC9,
    0xC7,0xC7,0x93,0x93,0xBB,0xBB,0xBF,0xBF,
    // y
    0x00,0x00,0x00,0x64,0x00,0x34,0x00,0x18,
    0x00,0x18,0x00,0x30,0x00,0x60,0x00,0x00,
    // z
    0x00,0x00,0x00,0x7C,0x00,0x18,0x00,0x30,
    0x00,0x20,0x00,0x60,0x00,0x7C,0x00,0x00
};

unsigned char black_tiles[] = {
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01, 0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01, 0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01, 0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01, 0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01, 0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01, 0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01, 0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01, 0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01, 0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01, 0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01, 0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01, 0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 0x01, 0x01,
};

unsigned char empty_tiles[] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00, 0x00
};

char get_char_position(unsigned char character)
{
    switch (character)
    {
    case 'a': return 1;
    case 'b': return 2;
    case 'c': return 3;
    case 'd': return 4;
    case 'e': return 5;
    case 'f': return 6;
    case 'g': return 7;
    case 'h': return 8;
    case 'i': return 9;
    case 'j': return 10;
    case 'k': return 11;
    case 'l': return 12;
    case 'm': return 13;
    case 'n': return 14;
    case 'o': return 15;
    case 'p': return 16;
    case 'q': return 17;
    case 'r': return 18;
    case 's': return 19;
    case 't': return 20;
    case 'u': return 21;
    case 'v': return 22;
    case 'w': return 23;
    case 'x': return 24;
    case 'y': return 25;
    case 'z': return 26;
    default: return 0;
    }
}

#define TEXT_WIDTH 18
#define NUMBER_OF_ROWS 6
#define ALPHABET_START_OFFSET 1
#define TEXT_COLUMN_OFFSET 1
#define CURSOR_MAX_EXCLUSIVE TEXT_WIDTH * NUMBER_OF_ROWS
#define TEXT_DELAY 50

int cursor = 0;

/*
returns 0 if the full string is rendered, otherwise returns an int of the offset of the string.
*/
int text_box_print(char * str_char)
{
    int offset = 0;
    while(*str_char != '\0' && cursor < CURSOR_MAX_EXCLUSIVE)
    {
        if(*str_char == '\n')
        {
            new_line();
            offset++;
            str_char++;
        }
        short x = (cursor % TEXT_WIDTH) + TEXT_COLUMN_OFFSET;
        short y = (cursor / TEXT_WIDTH) + 12;
        char tile_number = get_char_position(*str_char) + 1;
        unsigned char tile_number_array [1]= {tile_number};
        set_bkg_tiles(x, y, 1, 1, tile_number_array);
        delay(20);
        cursor++;
        offset++;
        str_char++;
    }
    if(*str_char == '\0')
    {
        return 0;
    } else {
        return  offset;
    }
}

void clear_text_box(){
    cursor = 0;
    set_bkg_tiles(0, 12, 20, 6, black_tiles);
}

void render_whole_text(char * text)
{
    clear_text_box();
    int rendered_offset = text_box_print(text);
    while(rendered_offset > 0){
        await_a_button_press();
        clear_text_box();
        text += rendered_offset;
        rendered_offset = text_box_print(text);
    }
}

int a_button_is_pressed()
{
    return joypad() & J_A;
}

void new_line()
{
    if(cursor == (CURSOR_MAX_EXCLUSIVE - 1))
    {
        await_a_button_press();
        clear_text_box();
        return;
    }
    int row = cursor / TEXT_WIDTH;
    if(row >= (NUMBER_OF_ROWS - 1))
    {
        cursor = CURSOR_MAX_EXCLUSIVE - 1;
        return;
    }
    cursor = (row + 1) * TEXT_WIDTH - 1;
}

void await_a_button_press()
{
    unsigned int blinking_a_button = 2;
    int loops = 0;
    while(!a_button_is_pressed()){
        if(loops % 6 == 0){
            // every 300 ms
            int blinking_a_ref [] = {blinking_a_button - 1};
            set_bkg_tiles(19,17, 1,1,blinking_a_ref);
            blinking_a_button = ((blinking_a_button + 1) % 2) + 2;
        }
        delay(50);
        loops++;
    }
}

void initialise_font(){
    set_bkg_data(0x01, 27, alphabet);
    set_bkg_tiles(0, 0, 20, 12, empty_tiles);
    set_bkg_tiles(0, 12, 20, 6, black_tiles);
}

#endif